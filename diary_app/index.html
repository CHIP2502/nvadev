<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nháº­t kÃ½</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ“” Nháº­t kÃ½ cÃ¡ nhÃ¢n</h1>

  <!-- Form Ä‘Äƒng nháº­p -->
  <div id="login-section">
    <h2>ÄÄƒng nháº­p</h2>
    <input id="username" placeholder="TÃªn Ä‘Äƒng nháº­p">
    <input id="password" type="password" placeholder="Máº­t kháº©u">
    <button onclick="login()">ÄÄƒng nháº­p</button>
    <p id="login-msg"></p>
  </div>

  <!-- Form viáº¿t / sá»­a nháº­t kÃ½ -->
  <div id="diary-section" style="display:none;">
    <h2 id="form-title">âœï¸ Viáº¿t nháº­t kÃ½</h2>
    <input id="title" placeholder="TiÃªu Ä‘á»">
    <input id="emotion" placeholder="Cáº£m xÃºc (ğŸ˜ŠğŸ˜¢ğŸ˜¡)">
    <input id="date" type="datetime-local">
    <textarea id="content" placeholder="Ná»™i dung..."></textarea><br>
    <label><input type="checkbox" id="isPublic"> ÄÄƒng cÃ´ng khai</label><br>
    <button onclick="saveEntry()">ğŸ’¾ LÆ°u</button>
    <button id="cancel-edit" onclick="cancelEdit()" style="display:none;">âŒ Há»§y</button>
    <p id="save-msg"></p>

    <hr>
    <h2>ğŸ” TÃ¬m kiáº¿m / Lá»c nháº­t kÃ½</h2>
    <input id="searchKeyword" placeholder="Tá»« khÃ³a...">
    <br>
    Tá»« ngÃ y: <input type="date" id="fromDate">
    Äáº¿n ngÃ y: <input type="date" id="toDate"><br>
    Cáº£m xÃºc: <input id="filterEmotion" placeholder="ğŸ˜Š, ğŸ˜¢, ğŸ˜¡...">
    <button onclick="applyFilter()">Lá»c</button>
    <button onclick="clearFilter()">XÃ³a lá»c</button>

    <hr>
    <h2>ğŸ“– Nháº­t kÃ½ cá»§a tÃ´i</h2>
    <div id="my-entries"></div>

    <hr>
    <a href="public.html">ğŸ“¢ Xem nháº­t kÃ½ cÃ´ng khai</a> | 
    <button onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>
  </div>

  <script>
    const users = [
      {username: "user1", password: "123"},
      {username: "user2", password: "456"}
    ];
    let currentUser = null;
    let editId = null; // ID bÃ i Ä‘ang sá»­a

    function login(){
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      const valid = users.find(x => x.username===u && x.password===p);
      if(valid){
        currentUser = u;
        localStorage.setItem("currentUser", currentUser);
        document.getElementById("login-section").style.display="none";
        document.getElementById("diary-section").style.display="block";
        loadMyEntries();
      } else {
        document.getElementById("login-msg").innerText="âŒ Sai tÃ i khoáº£n hoáº·c máº­t kháº©u!";
      }
    }

    function logout(){
      currentUser = null;
      localStorage.removeItem("currentUser");
      document.getElementById("login-section").style.display="block";
      document.getElementById("diary-section").style.display="none";
    }

    function saveEntry(){
      if(!currentUser) return;
      let entries = JSON.parse(localStorage.getItem("diaryEntries")||"[]");

      if(editId){ 
        let idx = entries.findIndex(e => e.id===editId && e.user===currentUser);
        if(idx>-1){
          entries[idx].title = document.getElementById("title").value;
          entries[idx].emotion = document.getElementById("emotion").value;
          entries[idx].date = document.getElementById("date").value;
          entries[idx].content = document.getElementById("content").value;
          entries[idx].isPublic = document.getElementById("isPublic").checked;
        }
        editId = null;
        document.getElementById("form-title").innerText="âœï¸ Viáº¿t nháº­t kÃ½";
        document.getElementById("cancel-edit").style.display="none";
      } else {
        const entry = {
          id: Date.now(),
          user: currentUser,
          title: document.getElementById("title").value,
          emotion: document.getElementById("emotion").value,
          date: document.getElementById("date").value,
          content: document.getElementById("content").value,
          isPublic: document.getElementById("isPublic").checked
        };
        entries.push(entry);
      }

      localStorage.setItem("diaryEntries", JSON.stringify(entries));
      document.getElementById("save-msg").innerText="âœ… ÄÃ£ lÆ°u!";
      clearForm();
      loadMyEntries();
    }

    function loadMyEntries(filteredList=null){
      let entries = JSON.parse(localStorage.getItem("diaryEntries")||"[]");
      let myEntries = entries.filter(e => e.user === currentUser);
      if(filteredList) myEntries = filteredList;

      const container = document.getElementById("my-entries");
      container.innerHTML="";
      if(myEntries.length===0){
        container.innerHTML="<p>KhÃ´ng cÃ³ nháº­t kÃ½ nÃ o.</p>";
        return;
      }
      myEntries.reverse().forEach(e=>{
        const div=document.createElement("div");
        div.className="entry";
        div.innerHTML=`
          <h3>${e.title} (${e.emotion})</h3>
          <p><b>NgÃ y:</b> ${e.date}</p>
          <p>${e.content}</p>
          <small>${e.isPublic?"ğŸŒ CÃ´ng khai":"ğŸ”’ RiÃªng tÆ°"}</small><br>
          <button onclick="editEntry(${e.id})">âœï¸ Sá»­a</button>
          <button onclick="deleteEntry(${e.id})">ğŸ—‘ï¸ XÃ³a</button>
        `;
        container.appendChild(div);
      });
    }

    function editEntry(id){
      let entries = JSON.parse(localStorage.getItem("diaryEntries")||"[]");
      let e = entries.find(x => x.id===id && x.user===currentUser);
      if(!e) return;
      editId = id;
      document.getElementById("form-title").innerText="âœï¸ Sá»­a nháº­t kÃ½";
      document.getElementById("cancel-edit").style.display="inline";
      document.getElementById("title").value = e.title;
      document.getElementById("emotion").value = e.emotion;
      document.getElementById("date").value = e.date;
      document.getElementById("content").value = e.content;
      document.getElementById("isPublic").checked = e.isPublic;
    }

    function cancelEdit(){
      editId = null;
      clearForm();
      document.getElementById("form-title").innerText="âœï¸ Viáº¿t nháº­t kÃ½";
      document.getElementById("cancel-edit").style.display="none";
    }

    function deleteEntry(id){
      if(!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a nháº­t kÃ½ nÃ y?")) return;
      let entries = JSON.parse(localStorage.getItem("diaryEntries")||"[]");
      entries = entries.filter(e => !(e.id===id && e.user===currentUser));
      localStorage.setItem("diaryEntries", JSON.stringify(entries));
      loadMyEntries();
    }

    function clearForm(){
      document.getElementById("title").value="";
      document.getElementById("emotion").value="";
      document.getElementById("date").value="";
      document.getElementById("content").value="";
      document.getElementById("isPublic").checked=false;
    }

    // ---- Bá»™ lá»c ----
    function applyFilter(){
      let entries = JSON.parse(localStorage.getItem("diaryEntries")||"[]");
      let myEntries = entries.filter(e => e.user === currentUser);

      const keyword = document.getElementById("searchKeyword").value.toLowerCase();
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      const emo = document.getElementById("filterEmotion").value.trim();

      let filtered = myEntries.filter(e=>{
        let matchKeyword = !keyword || (e.title.toLowerCase().includes(keyword) || e.content.toLowerCase().includes(keyword));
        let matchDate = true;
        if(fromDate && e.date < fromDate) matchDate=false;
        if(toDate && e.date > toDate+"T23:59") matchDate=false;
        let matchEmotion = !emo || e.emotion.includes(emo);
        return matchKeyword && matchDate && matchEmotion;
      });

      loadMyEntries(filtered);
    }

    function clearFilter(){
      document.getElementById("searchKeyword").value="";
      document.getElementById("fromDate").value="";
      document.getElementById("toDate").value="";
      document.getElementById("filterEmotion").value="";
      loadMyEntries();
    }

    // Auto login náº¿u trÆ°á»›c Ä‘Ã³ chÆ°a logout
    window.onload = ()=>{
      let u = localStorage.getItem("currentUser");
      if(u){
        currentUser = u;
        document.getElementById("login-section").style.display="none";
        document.getElementById("diary-section").style.display="block";
        loadMyEntries();
      }
    }
  </script>
</body>
</html>
